"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const workspace_1 = require("@nrwl/workspace");
const schematics_1 = require("@angular-devkit/schematics");
function updateNgPackagrBuilder() {
    let skipInstall = true;
    return schematics_1.chain([
        workspace_1.updateBuilderConfig((_, target) => {
            target.builder = '@angular-devkit/build-angular:ng-packagr';
            return _;
        }, '@angular-devkit/build-ng-packagr:build'),
        workspace_1.updateJsonInTree('package.json', (json) => {
            if (json.dependencies &&
                json.dependencies['@angular-devkit/build-ng-packagr']) {
                skipInstall = false;
                delete json.dependencies['@angular-devkit/build-ng-packagr'];
            }
            if (json.devDependencies &&
                json.devDependencies['@angular-devkit/build-ng-packagr']) {
                skipInstall = false;
                delete json.devDependencies['@angular-devkit/build-ng-packagr'];
            }
            return json;
        }),
    ]);
}
function updateLazyConfiguration(entry) {
    if (typeof entry === 'string') {
        return entry;
    }
    let objectEntry = entry;
    if ('lazy' in objectEntry) {
        return Object.assign(Object.assign({}, objectEntry), { inject: !objectEntry.lazy, lazy: undefined });
    }
    else {
        return entry;
    }
}
const removeDeprecatedOptions = workspace_1.updateBuilderConfig((options) => {
    delete options.environment;
    delete options.extractCss;
    delete options.tsconfigFileName;
    delete options.rebaseRootRelativeCssUrls;
    if (options.styles && Array.isArray(options.styles)) {
        options.styles = options.styles.map(updateLazyConfiguration);
    }
    if (options.scripts && Array.isArray(options.scripts)) {
        options.scripts = options.scripts.map(updateLazyConfiguration);
    }
    return options;
}, '@angular-devkit/build-angular:browser');
exports.default = () => {
    return schematics_1.chain([removeDeprecatedOptions, updateNgPackagrBuilder()]);
};
//# sourceMappingURL=update-builders-config.js.map